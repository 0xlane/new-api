name: Sync Upstream Release

on:
  schedule:
    # æ¯å¤© UTC æ—¶é—´ 0 ç‚¹ï¼ˆåŒ—äº¬æ—¶é—´æ—©ä¸Š 8 ç‚¹ï¼‰æ£€æŸ¥ä¸Šæ¸¸æ›´æ–°
    - cron: '0 0 * * *'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

env:
  UPSTREAM_REPO: QuantumNous/new-api

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: main
          token: ${{ secrets.ACTION_PAT }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Add upstream remote
        run: |
          git remote add upstream https://github.com/${{ env.UPSTREAM_REPO }}.git
          # ä¸æ‹‰å– tagsï¼Œé¿å…è¦†ç›–æœ¬åœ°å®šåˆ¶ç‰ˆæœ¬çš„ tags
          git fetch upstream --no-tags

      - name: Get latest upstream release tag
        id: get_release
        run: |
          # èŽ·å–ä¸Šæ¸¸æœ€æ–°çš„ release tag
          LATEST_TAG=$(curl -s https://api.github.com/repos/${{ env.UPSTREAM_REPO }}/releases/latest | jq -r .tag_name)
          echo "latest_tag=$LATEST_TAG" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Latest upstream release: $LATEST_TAG"

      - name: Check if already synced
        id: check_sync
        run: |
          TAG="${{ steps.get_release.outputs.latest_tag }}"
          if [ "$TAG" = "null" ] || [ -z "$TAG" ]; then
            echo "âŒ No release tag found"
            echo "should_sync=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # èŽ·å–ä¸Šæ¸¸ release tag å¯¹åº”çš„ commitï¼ˆæ˜Žç¡®ä½¿ç”¨ refs/tags ç¡®ä¿èŽ·å–ä¸Šæ¸¸çš„ tagï¼‰
          TAG_COMMIT=$(git ls-remote upstream "refs/tags/$TAG" | awk '{print $1}')
          
          # å¦‚æžœæ˜¯ annotated tagï¼Œéœ€è¦èŽ·å–å®žé™…çš„ commit
          if [ -n "$TAG_COMMIT" ]; then
            # å°è¯•è§£å¼•ç”¨ annotated tag
            DEREF_COMMIT=$(git ls-remote upstream "refs/tags/$TAG^{}" | awk '{print $1}')
            if [ -n "$DEREF_COMMIT" ]; then
              TAG_COMMIT="$DEREF_COMMIT"
            fi
          fi
          
          if [ -z "$TAG_COMMIT" ]; then
            echo "âŒ Could not find tag commit for $TAG"
            echo "should_sync=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "ðŸ“ Upstream $TAG points to commit: $TAG_COMMIT"
          echo "tag_commit=$TAG_COMMIT" >> $GITHUB_OUTPUT

          # æ£€æŸ¥å½“å‰åˆ†æ”¯æ˜¯å¦å·²ç»åŒ…å«è¿™ä¸ªæäº¤
          if git merge-base --is-ancestor "$TAG_COMMIT" HEAD 2>/dev/null; then
            echo "âœ… Already synced with $TAG"
            echo "should_sync=false" >> $GITHUB_OUTPUT
          else
            echo "ðŸ”„ New release detected: $TAG"
            echo "should_sync=true" >> $GITHUB_OUTPUT
          fi

      - name: Merge upstream release
        if: steps.check_sync.outputs.should_sync == 'true'
        id: merge
        run: |
          TAG="${{ steps.get_release.outputs.latest_tag }}"
          TAG_COMMIT="${{ steps.check_sync.outputs.tag_commit }}"
          
          echo "ðŸ”„ Merging upstream release $TAG (commit: $TAG_COMMIT)..."
          
          # ä½¿ç”¨ commit hash åˆå¹¶ï¼Œç¡®ä¿åˆå¹¶çš„æ˜¯ä¸Šæ¸¸çš„ release è€Œä¸æ˜¯æœ¬åœ°åŒå tag
          if git merge "$TAG_COMMIT" -m "ðŸ”„ Sync upstream release $TAG" --no-edit --allow-unrelated-histories; then
            echo "âœ… Merge successful (no conflicts)"
            echo "merge_status=success" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ Merge has conflicts, aborting..."
            echo "merge_status=conflict" >> $GITHUB_OUTPUT
            
            # åˆ—å‡ºå†²çªæ–‡ä»¶
            echo "Conflicting files:"
            git diff --name-only --diff-filter=U
            
            # ä¸­æ­¢åˆå¹¶
            git merge --abort
            exit 1
          fi

      - name: Push changes
        if: steps.check_sync.outputs.should_sync == 'true' && steps.merge.outputs.merge_status == 'success'
        run: |
          git push origin main
          echo "âœ… Pushed to main branch"

      - name: Create tag
        if: steps.check_sync.outputs.should_sync == 'true' && steps.merge.outputs.merge_status == 'success'
        run: |
          TAG="${{ steps.get_release.outputs.latest_tag }}"
          
          # æ£€æŸ¥ tag æ˜¯å¦å·²å­˜åœ¨
          if git rev-parse "$TAG" >/dev/null 2>&1; then
            echo "â„¹ï¸ Tag $TAG already exists, skipping"
          else
            git tag "$TAG"
            git push origin "$TAG"
            echo "âœ… Created and pushed tag: $TAG"
          fi

      - name: Summary
        if: always()
        run: |
          TAG="${{ steps.get_release.outputs.latest_tag }}"
          TAG_COMMIT="${{ steps.check_sync.outputs.tag_commit }}"
          SHOULD_SYNC="${{ steps.check_sync.outputs.should_sync }}"
          MERGE_STATUS="${{ steps.merge.outputs.merge_status }}"
          
          echo "## ðŸ”„ ä¸Šæ¸¸åŒæ­¥ç»“æžœ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ä¸Šæ¸¸æœ€æ–°ç‰ˆæœ¬:** \`$TAG\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "$SHOULD_SYNC" = "false" ]; then
            echo "âœ… **çŠ¶æ€:** å·²æ˜¯æœ€æ–°ï¼Œæ— éœ€åŒæ­¥" >> $GITHUB_STEP_SUMMARY
          elif [ "$MERGE_STATUS" = "success" ]; then
            echo "âœ… **çŠ¶æ€:** åŒæ­¥æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "å·²è‡ªåŠ¨åˆå¹¶ä¸Šæ¸¸ release \`$TAG\` åˆ° main åˆ†æ”¯" >> $GITHUB_STEP_SUMMARY
          elif [ "$MERGE_STATUS" = "conflict" ]; then
            echo "âš ï¸ **çŠ¶æ€:** å­˜åœ¨å†²çªï¼Œéœ€è¦æ‰‹åŠ¨å¤„ç†" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "è¯·æ‰‹åŠ¨æ‰§è¡Œä»¥ä¸‹å‘½ä»¤è§£å†³å†²çªï¼š" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
            echo "git remote add upstream https://github.com/${{ env.UPSTREAM_REPO }}.git" >> $GITHUB_STEP_SUMMARY
            echo "git fetch upstream --no-tags" >> $GITHUB_STEP_SUMMARY
            echo "# åˆå¹¶æŒ‡å®šçš„ release tag: $TAG (commit: $TAG_COMMIT)" >> $GITHUB_STEP_SUMMARY
            echo "git merge $TAG_COMMIT -m 'ðŸ”„ Sync upstream release $TAG' --allow-unrelated-histories" >> $GITHUB_STEP_SUMMARY
            echo "# è§£å†³å†²çªåŽ" >> $GITHUB_STEP_SUMMARY
            echo "git add ." >> $GITHUB_STEP_SUMMARY
            echo "git commit" >> $GITHUB_STEP_SUMMARY
            echo "git push origin main" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **çŠ¶æ€:** åŒæ­¥å¤±è´¥" >> $GITHUB_STEP_SUMMARY
          fi
