name: Sync Upstream Release

on:
  schedule:
    # æ¯å¤© UTC æ—¶é—´ 0 ç‚¹ï¼ˆåŒ—äº¬æ—¶é—´æ—©ä¸Š 8 ç‚¹ï¼‰æ£€æŸ¥ä¸Šæ¸¸æ›´æ–°
    - cron: '0 0 * * *'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

env:
  UPSTREAM_REPO: QuantumNous/new-api

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Add upstream remote
        run: |
          git remote add upstream https://github.com/${{ env.UPSTREAM_REPO }}.git
          git fetch upstream --tags

      - name: Get latest upstream release tag
        id: get_release
        run: |
          # è·å–ä¸Šæ¸¸æœ€æ–°çš„ release tag
          LATEST_TAG=$(curl -s https://api.github.com/repos/${{ env.UPSTREAM_REPO }}/releases/latest | jq -r .tag_name)
          echo "latest_tag=$LATEST_TAG" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ Latest upstream release: $LATEST_TAG"

      - name: Check if tag exists locally
        id: check_tag
        run: |
          TAG="${{ steps.get_release.outputs.latest_tag }}"
          if [ "$TAG" = "null" ] || [ -z "$TAG" ]; then
            echo "âŒ No release tag found"
            echo "should_sync=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # æ£€æŸ¥æœ¬åœ°æ˜¯å¦å·²æœ‰è¿™ä¸ª tag çš„åŒæ­¥åˆ†æ”¯æˆ– PR
          BRANCH_NAME="sync-upstream-${TAG}"
          
          # æ£€æŸ¥åˆ†æ”¯æ˜¯å¦å­˜åœ¨
          if git ls-remote --heads origin "$BRANCH_NAME" | grep -q "$BRANCH_NAME"; then
            echo "âœ… Sync branch already exists: $BRANCH_NAME"
            echo "should_sync=false" >> $GITHUB_OUTPUT
          else
            echo "ğŸ”„ New release detected, will create sync PR"
            echo "should_sync=true" >> $GITHUB_OUTPUT
            echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
          fi

      - name: Fetch upstream tag
        if: steps.check_tag.outputs.should_sync == 'true'
        run: |
          git fetch upstream tag ${{ steps.get_release.outputs.latest_tag }} --no-tags

      - name: Create sync branch
        if: steps.check_tag.outputs.should_sync == 'true'
        run: |
          BRANCH_NAME="${{ steps.check_tag.outputs.branch_name }}"
          git checkout -b "$BRANCH_NAME"
          echo "âœ… Created branch: $BRANCH_NAME"

      - name: Merge upstream release
        if: steps.check_tag.outputs.should_sync == 'true'
        id: merge
        run: |
          TAG="${{ steps.get_release.outputs.latest_tag }}"
          
          # å°è¯•åˆå¹¶ä¸Šæ¸¸ tag
          if git merge "$TAG" --no-edit; then
            echo "âœ… Merge successful"
            echo "has_conflicts=false" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ Merge has conflicts"
            echo "has_conflicts=true" >> $GITHUB_OUTPUT
            
            # åˆ—å‡ºå†²çªæ–‡ä»¶
            echo "Conflicting files:"
            git diff --name-only --diff-filter=U
            
            # ä¿ç•™å†²çªæ ‡è®°ï¼Œè®©äººå·¥å¤„ç†
            git add -A
            git commit -m "Merge upstream $TAG (conflicts need resolution)" --no-verify || true
          fi

      - name: Push sync branch
        if: steps.check_tag.outputs.should_sync == 'true'
        run: |
          BRANCH_NAME="${{ steps.check_tag.outputs.branch_name }}"
          git push origin "$BRANCH_NAME"
          echo "âœ… Pushed branch: $BRANCH_NAME"

      - name: Get upstream release notes
        if: steps.check_tag.outputs.should_sync == 'true'
        id: release_notes
        run: |
          NOTES=$(curl -s https://api.github.com/repos/${{ env.UPSTREAM_REPO }}/releases/latest | jq -r .body | head -c 3000)
          # è½¬ä¹‰ç‰¹æ®Šå­—ç¬¦
          NOTES="${NOTES//'%'/'%25'}"
          NOTES="${NOTES//$'\n'/'%0A'}"
          NOTES="${NOTES//$'\r'/'%0D'}"
          echo "notes=$NOTES" >> $GITHUB_OUTPUT

      - name: Create Pull Request
        if: steps.check_tag.outputs.should_sync == 'true'
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          TAG="${{ steps.get_release.outputs.latest_tag }}"
          BRANCH_NAME="${{ steps.check_tag.outputs.branch_name }}"
          HAS_CONFLICTS="${{ steps.merge.outputs.has_conflicts }}"
          
          # æ„å»º PR æè¿°
          if [ "$HAS_CONFLICTS" = "true" ]; then
            CONFLICT_WARNING="## âš ï¸ åˆå¹¶å†²çª

          æ­¤ PR å­˜åœ¨åˆå¹¶å†²çªï¼Œéœ€è¦æ‰‹åŠ¨è§£å†³ã€‚è¯·ç‰¹åˆ«æ³¨æ„ä»¥ä¸‹å¯èƒ½è¢«ä¿®æ”¹çš„æ–‡ä»¶ï¼š
          - \`model/log.go\` - æ—¥å¿—è®°å½•ç›¸å…³
          - \`controller/relay.go\` - é”™è¯¯å¤„ç†ç›¸å…³
          - \`service/quota.go\` - é…é¢æ¶ˆè´¹ç›¸å…³

          "
          else
            CONFLICT_WARNING=""
          fi
          
          gh pr create \
            --title "ğŸ”„ Sync upstream release ${TAG}" \
            --body "${CONFLICT_WARNING}## ğŸ“¦ ä¸Šæ¸¸æ›´æ–°

          æ­¤ PR è‡ªåŠ¨åŒæ­¥ä¸Šæ¸¸ä»“åº“ [${UPSTREAM_REPO}](https://github.com/${UPSTREAM_REPO}) çš„æœ€æ–° releaseã€‚

          **Release ç‰ˆæœ¬:** \`${TAG}\`
          **Release é“¾æ¥:** https://github.com/${UPSTREAM_REPO}/releases/tag/${TAG}

          ## ğŸ“‹ æ£€æŸ¥æ¸…å•

          åˆå¹¶å‰è¯·ç¡®è®¤ï¼š
          - [ ] æ£€æŸ¥æ˜¯å¦æœ‰å†²çªéœ€è¦è§£å†³
          - [ ] ç¡®è®¤è‡ªå®šä¹‰çš„æ—¥å¿—è®°å½•ä»£ç æ²¡æœ‰è¢«è¦†ç›–
          - [ ] æœ¬åœ°æµ‹è¯•é€šè¿‡

          ## ğŸ“ ä¸Šæ¸¸ Release Notes

          <details>
          <summary>ç‚¹å‡»å±•å¼€</summary>

          ${{ steps.release_notes.outputs.notes }}

          </details>
          " \
            --base main \
            --head "$BRANCH_NAME" \

      - name: Summary
        if: always()
        run: |
          echo "## åŒæ­¥ç»“æœ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.check_tag.outputs.should_sync }}" = "true" ]; then
            echo "âœ… å·²åˆ›å»ºåŒæ­¥ PR for release \`${{ steps.get_release.outputs.latest_tag }}\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "â„¹ï¸ æ— éœ€åŒæ­¥ï¼Œå½“å‰å·²æ˜¯æœ€æ–°æˆ–åŒæ­¥åˆ†æ”¯å·²å­˜åœ¨" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ä¸Šæ¸¸æœ€æ–°ç‰ˆæœ¬:** \`${{ steps.get_release.outputs.latest_tag }}\`" >> $GITHUB_STEP_SUMMARY

